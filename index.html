<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-commerce DinÃ¢mico com Firebase Realtime e Vue 3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    
    <style>
        /* (Seu CSS original, mantido para consistÃªncia visual) */
        :root {
            --primary-color: #ff8c00; 
            --secondary-color: #333;
            --success-color: #1e8449; 
            --danger-color: #e74c3c;
            --background-light: #f9fafb;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius-large: 12px;
            --border-radius-small: 6px;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--background-light);
            color: var(--secondary-color);
            line-height: 1.6;
        }
        #app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h2 {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--secondary-color);
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        .navbar {
            display: flex;
            justify-content: center;
            padding: 15px 10px;
            background-color: #fff;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            border-radius: var(--border-radius-large);
            margin-bottom: 30px;
        }
        .navbar button {
            background: none;
            border: none;
            padding: 12px 25px;
            margin: 0 5px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #777;
            border-radius: var(--border-radius-small);
        }
        .navbar button.active {
            color: var(--primary-color);
            background-color: #fff0e5; 
            box-shadow: inset 0 -3px 0 0 var(--primary-color); 
        }
        .content-area {
            background-color: #fff;
            padding: 30px;
            border-radius: var(--border-radius-large);
            box-shadow: var(--card-shadow);
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        .product-card {
            padding: 15px; 
            border-radius: var(--border-radius-large);
            text-align: center;
            border: 1px solid #eee;
        }
        .product-image {
            width: 100%;
            height: 140px; 
            object-fit: contain;
            border-radius: var(--border-radius-small);
            margin-bottom: 10px; 
        }
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
            font-weight: 600;
        }
        .quantity-control input[type="number"] {
            width: 50px;
            padding: 8px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: var(--border-radius-small);
            font-weight: 600;
        }
        .product-card button {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            margin-top: 5px; 
            font-weight: 600;
            width: 100%;
        }
        .cart-item {
            display: grid;
            grid-template-columns: 1fr 200px 120px; 
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .cart-actions {
            display: flex;
            align-items: center;
            justify-content: flex-end; 
            gap: 8px;
        }
        .cart-actions button {
            padding: 8px 12px;
            background-color: var(--primary-color); 
            color: white;
            border: none;
            border-radius: var(--border-radius-small);
            font-weight: 700;
        }
        .cart-actions button.remove {
            background-color: var(--danger-color);
        }
        .item-subtotal {
            text-align: right;
            font-weight: 700;
            color: var(--primary-color); 
            font-size: 1.2em;
        }
        .total-section {
            text-align: right;
            margin-top: 30px;
            font-size: 1.5em;
            font-weight: 700;
            padding: 20px 0;
            border-top: 3px solid var(--primary-color);
        }
        .checkout-button {
            width: 100%;
            padding: 18px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-large);
            font-size: 1.2em;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(255, 140, 0, 0.4);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-container {
            background: #fff;
            padding: 30px;
            border-radius: var(--border-radius-large);
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        .modal-container h3 {
            color: var(--primary-color);
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .modal-container input, .modal-container textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius-small);
            box-sizing: border-box;
            font-size: 1em;
        }
        .modal-container button.primary {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius-small);
            width: 100%;
            font-weight: 600;
            margin-top: 10px;
            cursor: pointer;
        }
        .modal-container button.secondary {
            background: none;
            color: var(--primary-color);
            border: none;
            width: 100%;
            margin-top: 10px;
            cursor: pointer;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }
        .loading-message {
            text-align: center; 
            padding: 40px; 
            font-size: 1.2em;
            color: #555;
            background-color: #f7f7f7;
            border-radius: var(--border-radius-large);
        }
        @media (max-width: 768px) {
            .navbar { flex-wrap: wrap; justify-content: space-around; }
            .navbar button { width: 45%; margin: 5px 0; padding: 10px 0; font-size: 14px; }
            .product-grid { grid-template-columns: 1fr; }
            .product-image { height: 120px; }
            .cart-item { grid-template-columns: 1fr; grid-template-rows: auto auto; gap: 10px; padding: 15px 0; }
            .item-subtotal { text-align: left; border-top: 1px dashed #eee; padding-top: 10px; }
            .cart-actions { justify-content: space-between; }
        }
    </style>
</head>
<body>

    <div id="app">
        
        <nav class="navbar">
            <button 
                :class="{ 'active': currentView === 'produtos' }" 
                @click="currentView = 'produtos'">
                ğŸ›ï¸ Produtos
            </button>
            <button 
                :class="{ 'active': currentView === 'carrinho' }" 
                @click="currentView = 'carrinho'">
                ğŸ›’ Carrinho ({{ totalCartItems }})
            </button>
            <button 
                :class="{ 'active': currentView === 'pedidos' }" 
                @click="currentView = 'pedidos'">
                ğŸ“¦ Meus Pedidos
            </button>
            <button @click="isLoggedIn ? logout() : openProfileModal('login')">
                {{ isLoggedIn ? `Sair (${userProfile.name.split(' ')[0]})` : 'ğŸ‘¤ Entrar/Cadastrar' }}
            </button>
        </nav>

        <div class="content-area">

            <div v-if="currentView === 'produtos'">
                <h2>CatÃ¡logo de Produtos</h2>

                <div v-if="isLoading" class="loading-message">
                    Carregando produtos do Firebase... â³
                </div>
                <div v-else-if="products.length === 0" class="loading-message" style="background-color: #ffe0e0; color: var(--danger-color);">
                    Nenhum produto encontrado. Verifique a conexÃ£o ou a estrutura do Firebase.
                </div>

                <div v-else class="product-grid">
                    <div class="product-card" v-for="product in products" :key="product.id">
                        <img :src="product.imageUrl" :alt="product.name" class="product-image">
                        <h3>{{ product.name }}</h3>
                        <p>PreÃ§o unitÃ¡rio: **R$ {{ product.price.toFixed(2).replace('.', ',') }}**</p>
                        
                        <div class="quantity-control">
                            <label>Qtd:</label>
                            <input 
                                type="number" 
                                v-model.number="product.quantityToAdd" 
                                min="1" 
                                @change="ensureMinQuantity(product)"
                            >
                        </div>

                        <button @click="addToCart(product, product.quantityToAdd)">
                            Adicionar ao Carrinho
                        </button>
                    </div>
                </div>
            </div>

            <div v-else-if="currentView === 'carrinho'">
                <h2>Seu Carrinho de Compras</h2>
                <ul class="cart-list" v-if="cartItems.length > 0">
                    <li class="cart-item" v-for="item in cartItems" :key="item.id">
                        <div class="cart-item-details">
                            **{{ item.name }}** <br>
                            <em>(R$ {{ item.price.toFixed(2).replace('.', ',') }} / unidade)</em>
                        </div>
                        <div class="cart-actions">
                            <button @click="updateCartQuantity(item, -1)">-</button>
                            <span>{{ item.quantity }}</span>
                            <button @click="updateCartQuantity(item, 1)">+</button>
                            <button class="remove" @click="removeFromCart(item.id)">Remover</button>
                        </div>
                        <div class="item-subtotal">
                            Subtotal: R$ {{ (item.price * item.quantity).toFixed(2).replace('.', ',') }}
                        </div>
                    </li>
                </ul>
                <p v-else style="text-align: center; padding: 20px; color: #777;">Seu carrinho estÃ¡ vazio. Adicione alguns produtos!</p>

                <div v-if="cartItems.length > 0">
                    <div class="total-section">
                        Total Geral: **R$ {{ totalCartPrice.toFixed(2).replace('.', ',') }}**
                    </div>
                    <button class="checkout-button" @click="checkout">
                        Finalizar Compra
                    </button>
                </div>
            </div>

            <div v-else-if="currentView === 'pedidos'">
                <h2>Meus Pedidos</h2>
                <div v-if="!isLoggedIn" style="text-align: center; padding: 30px; background-color: #fff0e5; border: 1px solid var(--primary-color); border-radius: 8px; color: var(--secondary-color);">
                    FaÃ§a login para ver seus pedidos.
                </div>
                <ul class="orders-list" v-else-if="userOrders.length > 0">
                    <li class="order-item" v-for="order in userOrders" :key="order.id">
                        <div>
                            **Pedido #{{ order.id.substring(0, 8) }}** ({{ order.date }})
                            <br>
                            <span style="font-size: 0.9em; color: #777;">Cliente: {{ userProfile.name }}</span>
                        </div>
                        <div>
                            Status: **{{ order.status }}**
                            <br>
                            Total: **R$ {{ order.total.toFixed(2).replace('.', ',') }}**
                        </div>
                    </li>
                </ul>
                <p v-else style="text-align: center; padding: 20px; color: #777;">VocÃª ainda nÃ£o tem pedidos finalizados.</p>
            </div>

        </div>

        <div class="modal-overlay" v-if="isProfileModalOpen" @click.self="closeProfileModal">
            <div class="modal-container">
                <button class="modal-close-btn" @click="closeProfileModal">X</button>

                <div v-if="loginView === 'login'">
                    <h3>Acessar sua Conta</h3>
                    <form @submit.prevent="simulateLogin(tempLogin.email, tempLogin.password)">
                        <input type="email" v-model="tempLogin.email" placeholder="Seu E-mail" required>
                        <input type="password" v-model="tempLogin.password" placeholder="Sua Senha" required>
                        <button type="submit" class="primary">Entrar</button>
                    </form>
                    <button class="secondary" @click="loginView = 'register'">Ainda nÃ£o tenho conta? Cadastrar</button>
                </div>

                <div v-else-if="loginView === 'register'">
                    <h3>Criar Conta</h3>
                    <form @submit.prevent="simulateRegister(tempRegister.name, tempRegister.email, tempRegister.password)">
                        <input type="text" v-model="tempRegister.name" placeholder="Seu Nome Completo" required>
                        <input type="email" v-model="tempRegister.email" placeholder="Seu Melhor E-mail" required>
                        <input type="password" v-model="tempRegister.password" placeholder="Crie uma Senha Segura (min. 6 caracteres)" required minlength="6">
                        
                        <button type="submit" class="primary">Cadastrar e Entrar</button>
                    </form>
                    <button class="secondary" @click="loginView = 'login'">JÃ¡ tenho conta? Acessar</button>
                </div>

                <div v-else-if="loginView === 'address' && isLoggedIn">
                    <h3>EndereÃ§o de Entrega</h3>
                    <p>OlÃ¡, **{{ userProfile.name.split(' ')[0] }}**. Por favor, informe seu endereÃ§o para prosseguir.</p>
                    <form @submit.prevent="saveAddressAndCheckout">
                        <textarea v-model="userProfile.address" rows="3" placeholder="Rua, NÃºmero, Bairro, Cidade, CEP" required></textarea>
                        <button type="submit" class="primary">Salvar e Finalizar Compra</button>
                    </form>
                </div>

            </div>
        </div>
    </div>

<script>
Â  Â  const { createApp, ref, computed, onMounted, watch } = Vue;
Â  Â  
Â  Â  // â­ï¸ CONFIGURAÃ‡ÃƒO DO FIREBASE â­ï¸
Â  Â  // âš ï¸ ATENÃ‡ÃƒO: Substitua pelos seus dados REAIS do Firebase!
Â  Â  const firebaseConfig = {
Â  Â  Â  Â  apiKey: "AIzaSyAnGyAYBthXQs5rEylnLXCxOVQKKN1FP34",
Â  Â  Â  Â  authDomain: "grafica-619fd.firebaseapp.com",
Â  Â  Â  Â  databaseURL: "https://grafica-619fd-default-rtdb.firebaseio.com", 
Â  Â  Â  Â  projectId: "grafica-619fd",
Â  Â  Â  Â  storageBucket: "grafica-619fd.firebasestorage.app",
Â  Â  Â  Â  messagingSenderId: "1022124441596",
Â  Â  Â  Â  appId: "1:1022124441596:web:d6f25056f38a6babc67c79",
Â  Â  Â  Â  measurementId: "G-SQ4QNTFXCM"
Â  Â  }; 

Â  Â  const initializeFirebase = () => {
Â  Â  Â  Â  if (typeof firebase !== 'undefined' && typeof firebase.initializeApp !== 'undefined') {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  return firebase.initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao inicializar Firebase:", e);
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  console.error("Firebase SDK nÃ£o carregado. Verifique os links CDN.");
Â  Â  Â  Â  return null;
Â  Â  };

Â  Â  const app = initializeFirebase();

Â  Â  // ğŸ¯ LÃ“GICA DE PERSISTÃŠNCIA ğŸ¯
Â  Â  const STORAGE_KEY = 'user_logged_in_id'; 
Â  Â  const STORAGE_CART_KEY = 'anonymous_cart'; // Chave para carrinho anÃ´nimo
    const WHATSAPP_NUMBER = '81995038049'; // NÃºmero do WhatsApp para o pedido

Â  Â  const saveSession = (key) => {
Â  Â  Â  Â  localStorage.setItem(STORAGE_KEY, key);
Â  Â  };
Â  Â  
Â  Â  const clearSession = () => {
Â  Â  Â  Â  localStorage.removeItem(STORAGE_KEY);
Â  Â  Â  Â  localStorage.removeItem(STORAGE_CART_KEY); // Limpa o carrinho local ao sair
Â  Â  };
Â  Â  
Â  Â  // UtilitÃ¡rio para criar uma chave segura a partir do e-mail (usado como ID do usuÃ¡rio no DB)
Â  Â  const createSafeEmailKey = (email) => {
Â  Â  Â  Â  return email.toLowerCase().replace(/[\.\#\$\/\[\]]/g, '_');
Â  Â  };
Â  Â  // -----------------------------
Â  Â  
Â  Â  createApp({
Â  Â  Â  Â  setup() {
Â  Â  Â  Â  Â  Â  // --- 1. ESTADO CENTRAL ---
Â  Â  Â  Â  Â  Â  const currentView = ref('produtos'); 
Â  Â  Â  Â  Â  Â  const isLoggedIn = ref(false); 
Â  Â  Â  Â  Â  Â  const isLoading = ref(true); 

Â  Â  Â  Â  Â  Â  const userProfile = ref({
Â  Â  Â  Â  Â  Â  Â  Â  name: 'Convidado',
Â  Â  Â  Â  Â  Â  Â  Â  email: '',
Â  Â  Â  Â  Â  Â  Â  Â  address: '' 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const userId = ref(null); // E-mail sanitizado do usuÃ¡rio logado (chave do Firebase)

Â  Â  Â  Â  Â  Â  const isProfileModalOpen = ref(false);
Â  Â  Â  Â  Â  Â  const loginView = ref('login'); 

Â  Â  Â  Â  Â  Â  const tempLogin = ref({ email: '', password: '' });
Â  Â  Â  Â  Â  Â  const tempRegister = ref({ name: '', email: '', password: '' }); 

Â  Â  Â  Â  Â  Â  const products = ref([]); 
Â  Â  Â  Â  Â  Â  const cartItems = ref([]);
Â  Â  Â  Â  Â  Â  const userOrders = ref([]); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // -----------------------------------------------------------
Â  Â  Â  Â  Â  Â  // FUNÃ‡Ã•ES DE SINCRONIZAÃ‡ÃƒO DE DADOS (CARRINHO E PEDIDOS) 
Â  Â  Â  Â  Â  Â  // -----------------------------------------------------------

Â  Â  Â  Â  Â  Â  const saveCartLocal = () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!isLoggedIn.value) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(STORAGE_CART_KEY, JSON.stringify(cartItems.value));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const loadCartLocal = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const storedCart = localStorage.getItem(STORAGE_CART_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  if (storedCart) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartItems.value = JSON.parse(storedCart);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartItems.value = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartItems.value = [];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const saveCartToFirebase = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!userId.value) return; 
Â  Â  Â  Â  Â  Â  Â  Â  const db = firebase.database();
Â  Â  Â  Â  Â  Â  Â  Â  const cartRef = db.ref(`usuarios/${userId.value}/carrinho`);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cartDataToSave = cartItems.value.map(item => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: item.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: item.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  price: item.price,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imageUrl: item.imageUrl,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantity: item.quantity
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await cartRef.set(cartDataToSave);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao salvar carrinho no Firebase:", error);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const loadCartFromFirebase = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!userId.value) return;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const db = firebase.database();
Â  Â  Â  Â  Â  Â  Â  Â  const cartRef = db.ref(`usuarios/${userId.value}/carrinho`);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const snapshot = await cartRef.get();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loadedCart = snapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Adiciona a prop 'quantityToAdd' para o fluxo do usuÃ¡rio na tela de produtos
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartItems.value = Array.isArray(loadedCart) ? loadedCart.map(item => ({...item, quantityToAdd: 1})) : [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartItems.value = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao carregar carrinho do Firebase:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartItems.value = [];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const loadOrdersFromFirebase = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!userId.value) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userOrders.value = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const db = firebase.database();
Â  Â  Â  Â  Â  Â  Â  Â  const ordersRef = db.ref(`pedidos/${userId.value}`); 
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const snapshot = await ordersRef.get();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = snapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userOrders.value = Object.keys(data).map(key => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: key, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...data[key]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })).reverse(); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userOrders.value = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao carregar pedidos do Firebase:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userOrders.value = [];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  // Observa a alteraÃ§Ã£o do carrinho e salva localmente (se deslogado) ou no Firebase (se logado)
Â  Â  Â  Â  Â  Â  watch(cartItems, () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (isLoggedIn.value) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveCartToFirebase();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Nota: A limpeza do carrinho local para usuÃ¡rios logados Ã© tratada nas funÃ§Ãµes de login/cadastro/logout
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveCartLocal();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, { deep: true });

Â  Â  Â  Â  Â  Â  // -----------------------------------------------------------
Â  Â  Â  Â  Â  Â  // INICIALIZAÃ‡ÃƒO E AUTO-LOGIN
Â  Â  Â  Â  Â  Â  // -----------------------------------------------------------

Â  Â  Â  Â  Â  Â  const fetchProductsFromFirebase = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  // ... (mantida a lÃ³gica de carregamento de produtos, sem alteraÃ§Ãµes)
Â  Â  Â  Â  Â  Â  Â  Â  if (!app || typeof firebase.database === 'undefined') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isLoading.value = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  isLoading.value = true;
Â  Â  Â  Â  Â  Â  Â  Â  const db = firebase.database();
Â  Â  Â  Â  Â  Â  Â  Â  const productsRef = db.ref('produtos'); 

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const snapshot = await productsRef.get();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = snapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loadedProducts = [];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const key in data) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.hasOwnProperty(key)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const productData = data[key];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadedProducts.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: key, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: productData.name || 'Produto sem nome',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imageUrl: productData.imageUrl || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  price: parseFloat(productData.price) || 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantityToAdd: 1 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  products.value = loadedProducts;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  products.value = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao buscar produtos do Firebase:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Erro ao carregar o catÃ¡logo de produtos. Verifique sua conexÃ£o e regras do Firebase.");
Â  Â  Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isLoading.value = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const checkStoredUser = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  const storedId = localStorage.getItem(STORAGE_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (!storedId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isLoggedIn.value = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadCartLocal(); // Carrega carrinho anÃ´nimo, se houver
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const db = firebase.database();
Â  Â  Â  Â  Â  Â  Â  Â  const userRef = db.ref(`usuarios/${storedId}`);

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const snapshot = await userRef.get();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userData = snapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Loga o usuÃ¡rio automaticamente
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userId.value = storedId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userProfile.value.name = userData.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userProfile.value.email = userData.email;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userProfile.value.address = userData.address || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isLoggedIn.value = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Carrega Carrinho e Pedidos do Firebase
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadCartFromFirebase();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadOrdersFromFirebase();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearSession();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadCartLocal();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro no auto-login:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearSession();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadCartLocal();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  onMounted(() => {
Â  Â  Â  Â  Â  Â  Â  Â  fetchProductsFromFirebase();
Â  Â  Â  Â  Â  Â  Â  Â  checkStoredUser(); 
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // --- 2. PROPRIEDADES COMPUTADAS ---
Â  Â  Â  Â  Â  Â  const totalCartItems = computed(() => {
Â  Â  Â  Â  Â  Â  Â  Â  return cartItems.value.reduce((total, item) => total + item.quantity, 0);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const totalCartPrice = computed(() => {
Â  Â  Â  Â  Â  Â  Â  Â  return cartItems.value.reduce((total, item) => total + (item.price * item.quantity), 0);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // --- 3. MÃ‰TODOS DE AÃ‡ÃƒO (AUTENTICAÃ‡ÃƒO) ---
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const openProfileModal = (view = 'login') => {
Â  Â  Â  Â  Â  Â  Â  Â  loginView.value = view;
Â  Â  Â  Â  Â  Â  Â  Â  isProfileModalOpen.value = true;
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const closeProfileModal = () => {
Â  Â  Â  Â  Â  Â  Â  Â  isProfileModalOpen.value = false;
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * LÃ“GICA DE LOGIN (com sincronizaÃ§Ã£o de carrinho)
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  const simulateLogin = async (email, password) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!email.includes('@') || password.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Erro no login. Por favor, insira E-mail e Senha vÃ¡lidos.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const safeEmailKey = createSafeEmailKey(email);
Â  Â  Â  Â  Â  Â  Â  Â  const db = firebase.database();
Â  Â  Â  Â  Â  Â  Â  Â  const userRef = db.ref(`usuarios/${safeEmailKey}`);

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const snapshot = await userRef.get();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userData = snapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userData.password !== password) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("E-mail ou Senha incorretos.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 1. Captura o carrinho anÃ´nimo (se houver)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cartBeforeLogin = cartItems.value.slice(); 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. Efetua o login (estado Vue)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userId.value = safeEmailKey;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userProfile.value.name = userData.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userProfile.value.email = userData.email;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userProfile.value.address = userData.address || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isLoggedIn.value = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. Carrega o carrinho e pedidos do Firebase
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadOrdersFromFirebase();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadCartFromFirebase();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 4. Se o carrinho do Firebase estiver vazio, mas o local nÃ£o, transfere o local
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cartItems.value.length === 0 && cartBeforeLogin.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartItems.value = cartBeforeLogin; // Restaura o carrinho anÃ´nimo
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem(STORAGE_CART_KEY); // Limpa o local
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`ğŸ‰ Seu carrinho anÃ´nimo foi recuperado e salvo em sua conta!`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 5. PERSISTÃŠNCIA
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveSession(safeEmailKey);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeProfileModal();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`ğŸ‰ Login bem-sucedido! Bem-vindo(a) de volta, ${userData.name.split(' ')[0]}.`);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("E-mail nÃ£o encontrado. Por favor, cadastre-se primeiro.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao fazer login no Firebase:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Ocorreu um erro ao tentar fazer login.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * LÃ“GICA DE CADASTRO (com sincronizaÃ§Ã£o de carrinho)
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  const simulateRegister = async (name, email, password) => { 
Â  Â  Â  Â  Â  Â  Â  Â  if (!email.includes('@') || name.length <= 2 || password.length < 6) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Erro no cadastro. Verifique se Nome, E-mail e Senha (min. 6 caracteres) estÃ£o corretos.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const safeEmailKey = createSafeEmailKey(email);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const db = firebase.database();
Â  Â  Â  Â  Â  Â  Â  Â  const userRef = db.ref(`usuarios/${safeEmailKey}`);

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 1. Verifica se o usuÃ¡rio jÃ¡ existe
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const snapshot = await userRef.get();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("ERRO: Este e-mail jÃ¡ estÃ¡ cadastrado. Tente fazer o login.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. Captura o carrinho atual (anÃ´nimo)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cartBeforeRegister = cartItems.value.slice(); 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. Cria o novo perfil no Firebase
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await userRef.set({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  email: email,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  password: password,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  address: ''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 4. Efetua o login (estado Vue)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userId.value = safeEmailKey;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userProfile.value.name = name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userProfile.value.email = email;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isLoggedIn.value = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadOrdersFromFirebase();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 5. Transfere o carrinho da sessÃ£o anÃ´nima
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cartBeforeRegister.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartItems.value = cartBeforeRegister; // Isso dispara o watch, salvando no Firebase
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem(STORAGE_CART_KEY); // Limpa o local
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`Seu carrinho com ${cartBeforeRegister.length} itens foi salvo na sua nova conta!`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartItems.value = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 6. PERSISTÃŠNCIA
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveSession(safeEmailKey);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeProfileModal();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`âœ… Cadastro e Login bem-sucedidos! Bem-vindo(a), ${name.split(' ')[0]}.`);

Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao registrar no Firebase:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Ocorreu um erro ao tentar se cadastrar.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * LÃ“GICA DE LOGOUT
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  const logout = () => {
Â  Â  Â  Â  Â  Â  Â  Â  // 1. Garante que o carrinho logado Ã© limpo na memÃ³ria
Â  Â  Â  Â  Â  Â  Â  Â  cartItems.value = []; 

Â  Â  Â  Â  Â  Â  Â  Â  // 2. Limpa o estado da aplicaÃ§Ã£o e a persistÃªncia
Â  Â  Â  Â  Â  Â  Â  Â  isLoggedIn.value = false;
Â  Â  Â  Â  Â  Â  Â  Â  userId.value = null;
Â  Â  Â  Â  Â  Â  Â  Â  userProfile.value = { name: 'Convidado', email: '', address: '' };
Â  Â  Â  Â  Â  Â  Â  Â  userOrders.value = [];
Â  Â  Â  Â  Â  Â  Â  Â  clearSession();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  currentView.value = 'produtos';
Â  Â  Â  Â  Â  Â  Â  Â  alert("VocÃª foi desconectado(a) com sucesso.");
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // --- MÃ‰TODOS DE E-COMMERCE ---
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // FunÃ§Ãµes de Carrinho (addToCart, updateCartQuantity, removeFromCart, ensureMinQuantity...)
            // Mantidas as mesmas do cÃ³digo anterior.
            
Â  Â  Â  Â  Â  Â  const ensureMinQuantity = (product) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (product.quantityToAdd < 1 || isNaN(product.quantityToAdd)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  product.quantityToAdd = 1;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const addToCart = (product, quantity) => {
Â  Â  Â  Â  Â  Â  Â  Â  const qty = Math.max(1, parseInt(quantity) || 1);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const existingItem = cartItems.value.find(item => item.id === product.id);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (existingItem) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  existingItem.quantity += qty;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartItems.value.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: product.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: product.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  price: product.price,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imageUrl: product.imageUrl,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantity: qty,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  alert(`"${product.name}" adicionado ao carrinho!`);
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const updateCartQuantity = (item, delta) => {
Â  Â  Â  Â  Â  Â  Â  Â  const newQuantity = item.quantity + delta;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (newQuantity < 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  removeFromCart(item.id);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.quantity = newQuantity;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const removeFromCart = (productId) => {
Â  Â  Â  Â  Â  Â  Â  Â  cartItems.value = cartItems.value.filter(item => item.id !== productId);
Â  Â  Â  Â  Â  Â  Â  Â  alert("Item removido do carrinho.");
Â  Â  Â  Â  Â  Â  };
            
Â  Â  Â  Â  Â  Â  const checkout = () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (totalCartItems.value === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Seu carrinho estÃ¡ vazio!");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (!isLoggedIn.value) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Por favor, faÃ§a login ou cadastre-se para finalizar a compra.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openProfileModal('login');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (!userProfile.value.address || userProfile.value.address.trim() === '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Por favor, preencha seu endereÃ§o para finalizar o pedido.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openProfileModal('address'); // Pede o endereÃ§o
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  confirmOrder();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const saveAddressAndCheckout = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!userProfile.value.address || userProfile.value.address.trim() === '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("O campo de endereÃ§o nÃ£o pode estar vazio.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const db = firebase.database();
Â  Â  Â  Â  Â  Â  Â  Â  const userRef = db.ref(`usuarios/${userId.value}`);

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await userRef.update({ address: userProfile.value.address });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeProfileModal();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  confirmOrder();
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao salvar endereÃ§o:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Erro ao salvar o endereÃ§o. Tente novamente.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
            
            // --- 4. FUNÃ‡Ã•ES DE WHATSAPP ---

Â  Â  Â  Â  Â  Â  const sendOrderDetailsToWhatsApp = (orderId, orderData) => {
                // 1. Formata a lista de itens
                const itemsList = orderData.items.map(item => 
                    `* ${item.quantity}x ${item.name} (R$ ${item.price.toFixed(2)})`
                ).join('\n');

                // 2. Monta a mensagem completa
                const message = `
                    ğŸ›’ *NOVO PEDIDO RECEBIDO!* ğŸ›’

                    *ID do Pedido:* #${orderId.substring(0, 8).toUpperCase()}
                    *Data:* ${orderData.date}
                    *Total:* R$ ${orderData.total.toFixed(2)}

                    *CLIENTE:*
                    *Nome:* ${orderData.customer.name}
                    *Email:* ${orderData.customer.email}
                    *EndereÃ§o:* ${orderData.customer.address}

                    *ITENS DO PEDIDO:*
                    ${itemsList}

                    *(Confirme o pagamento e o envio. Agradecemos a preferÃªncia!)*
                `.trim();

                // 3. Codifica a mensagem e cria o link da API do WhatsApp
                const encodedMessage = encodeURIComponent(message);
                const whatsappLink = `https://wa.me/55${WHATSAPP_NUMBER}?text=${encodedMessage}`;

                // 4. Abre o link em uma nova aba
                window.open(whatsappLink, '_blank');
Â  Â  Â  Â  Â  Â  };


Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * LÃ“GICA DE CONFIRMAÃ‡ÃƒO DE PEDIDO (agora com WhatsApp)
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  const confirmOrder = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!isLoggedIn.value || !userId.value) return;

Â  Â  Â  Â  Â  Â  Â  Â  const db = firebase.database();
Â  Â  Â  Â  Â  Â  Â  Â  const newOrderRef = db.ref(`pedidos/${userId.value}`).push();

Â  Â  Â  Â  Â  Â  Â  Â  const orderData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date: new Date().toLocaleString('pt-BR'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total: totalCartPrice.value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'Processando',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  items: cartItems.value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  customer: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: userProfile.value.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  email: userProfile.value.email,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  address: userProfile.value.address
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 1. Salva no Firebase
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await newOrderRef.set(orderData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. Envia para o WhatsApp (abre nova aba/app)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sendOrderDetailsToWhatsApp(newOrderRef.key, orderData);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`âœ… Pedido ${newOrderRef.key.substring(0, 8)} finalizado! Redirecionando para o WhatsApp para confirmaÃ§Ã£o.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. Limpa o carrinho e atualiza o histÃ³rico
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartItems.value = []; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadOrdersFromFirebase();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentView.value = 'pedidos';

Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao finalizar pedido:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Ocorreu um erro ao processar seu pedido. Tente novamente.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  // Estado
Â  Â  Â  Â  Â  Â  Â  Â  currentView, products, cartItems, userOrders, userProfile, isLoggedIn, isLoading,
Â  Â  Â  Â  Â  Â  Â  Â  isProfileModalOpen, loginView, tempLogin, tempRegister,

Â  Â  Â  Â  Â  Â  Â  Â  // Computadas
Â  Â  Â  Â  Â  Â  Â  Â  totalCartItems, totalCartPrice,

Â  Â  Â  Â  Â  Â  Â  Â  // MÃ©todos de UI
Â  Â  Â  Â  Â  Â  Â  Â  openProfileModal, closeProfileModal, ensureMinQuantity,

Â  Â  Â  Â  Â  Â  Â  Â  // MÃ©todos de AutenticaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  simulateLogin, simulateRegister, logout,

Â  Â  Â  Â  Â  Â  Â  Â  // MÃ©todos de E-commerce
Â  Â  Â  Â  Â  Â  Â  Â  addToCart, updateCartQuantity, removeFromCart, checkout, saveAddressAndCheckout
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  }).mount('#app');
Â  </script>