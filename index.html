<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-commerce Final com Vue 3, Firebase Auth e Realtime DB</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    
    <style>
        /* --- Estilos (Mantidos do √∫ltimo c√≥digo) --- */
        :root {
            --primary-color: #ff8c00; 
            --secondary-color: #333;
            --success-color: #1e8449; 
            --danger-color: #e74c3c;
            --background-light: #f9fafb;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius-large: 12px;
            --border-radius-small: 6px;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--background-light);
            color: var(--secondary-color);
            line-height: 1.6;
        }
        #app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h2 {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--secondary-color);
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        
        /* --- Navega√ß√£o (Navbar) --- */
        .navbar {
            display: flex;
            justify-content: center;
            padding: 15px 10px;
            background-color: #fff;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            border-radius: var(--border-radius-large);
            margin-bottom: 30px;
        }
        .navbar button {
            background: none;
            border: none;
            padding: 12px 25px;
            margin: 0 5px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #777;
            border-radius: var(--border-radius-small);
        }
        .navbar button.active {
            color: var(--primary-color);
            background-color: #fff0e5; 
            box-shadow: inset 0 -3px 0 0 var(--primary-color); 
        }
        .content-area {
            background-color: #fff;
            padding: 30px;
            border-radius: var(--border-radius-large);
            box-shadow: var(--card-shadow);
        }

        /* --- Grid de Produtos --- */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        .product-card {
            padding: 15px; 
            border-radius: var(--border-radius-large);
            text-align: center;
            border: 1px solid #eee;
            transition: all 0.3s ease;
        }
        .product-card:hover {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .product-image {
            width: 100%;
            height: 140px; 
            object-fit: contain;
            border-radius: var(--border-radius-small);
            margin-bottom: 10px; 
        }
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
            font-weight: 600;
        }
        .quantity-control input[type="number"] {
            width: 50px;
            padding: 8px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: var(--border-radius-small);
            font-weight: 600;
        }
        .product-card button {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            margin-top: 5px; 
            font-weight: 600;
            width: 100%;
            transition: background-color 0.2s;
        }
        .product-card button:hover {
            background-color: #1a713e;
        }

        /* --- Grid de Carrinho --- */
        .cart-list {
            border: 1px solid #ddd;
            border-radius: var(--border-radius-large);
            overflow: hidden;
            margin-top: 20px;
        }
        
        .cart-item {
            display: grid;
            grid-template-columns: 1.5fr 1fr 0.5fr; 
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            background-color: #fff;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cart-header {
            font-weight: 700;
            background-color: #f5f5f5;
            color: var(--secondary-color);
            padding: 10px 20px;
            border-bottom: 2px solid #ddd;
        }
        .cart-header span {
            text-transform: uppercase;
            font-size: 0.9em;
        }
        
        .cart-item-details {
            font-size: 1.1em;
        }

        .cart-actions {
            display: flex;
            align-items: center;
            justify-content: center; 
            gap: 8px;
        }
        .cart-actions button {
            padding: 8px 12px;
            background-color: var(--primary-color); 
            color: white;
            border: none;
            border-radius: var(--border-radius-small);
            font-weight: 700;
            cursor: pointer;
            min-width: 40px;
            text-align: center;
        }
        .cart-actions span.quantity-display {
            font-weight: 700;
            padding: 0 5px;
            min-width: 20px;
            text-align: center;
        }
        .cart-actions button.remove {
            background-color: var(--danger-color);
            margin-left: 10px;
        }

        .item-subtotal {
            text-align: right;
            font-weight: 700;
            color: var(--primary-color); 
            font-size: 1.1em;
        }
        
        /* --- Se√ß√£o de Total e Finalizar --- */
        .total-section {
            text-align: right;
            margin-top: 30px;
            font-size: 1.5em;
            font-weight: 700;
            padding: 20px 0;
            border-top: 3px solid var(--primary-color);
        }
        .checkout-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        .checkout-button {
            width: 100%;
            padding: 18px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-large);
            font-size: 1.2em;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(255, 140, 0, 0.4);
            cursor: pointer;
            transition: all 0.2s;
        }
        .checkout-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .address-info {
            background-color: #f7f7f7;
            padding: 15px;
            border-radius: var(--border-radius-small);
            border-left: 5px solid var(--primary-color);
            font-size: 0.95em;
        }
        .address-info strong {
            display: block;
            margin-bottom: 5px;
            color: var(--secondary-color);
        }
        
        /* --- Modal e Outros Elementos --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-container {
            background: #fff;
            padding: 30px;
            border-radius: var(--border-radius-large);
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        .modal-container h3 {
            color: var(--primary-color);
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .modal-container input, .modal-container textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius-small);
            box-sizing: border-box;
            font-size: 1em;
        }
        /* Grid para o formul√°rio de endere√ßo */
        .address-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .address-form-grid > div {
            grid-column: span 2; /* Full width by default */
        }
        .address-form-grid > div.half-width {
            grid-column: span 1; /* Half width */
        }

        .modal-container button.primary {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius-small);
            width: 100%;
            font-weight: 600;
            margin-top: 10px;
            cursor: pointer;
        }
        .modal-container button.secondary {
            background: none;
            color: var(--primary-color);
            border: none;
            width: 100%;
            margin-top: 10px;
            cursor: pointer;
            padding: 8px 0;
        }
        .recover-link {
            text-align: center;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        .recover-link button {
            background: none;
            border: none;
            color: #777;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }
        .loading-message {
            text-align: center; 
            padding: 40px; 
            font-size: 1.2em;
            color: #555;
            background-color: #f7f7f7;
            border-radius: var(--border-radius-large);
        }
        
        /* --- Detalhes do Pedido (Nova Se√ß√£o) --- */
        .orders-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .order-item {
            padding: 20px;
            border: 1px solid #eee;
            border-radius: var(--border-radius-large);
            margin-bottom: 15px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .order-address-detail, .order-items-detail {
            margin-top: 15px;
            padding: 10px 15px;
            border-left: 4px solid var(--primary-color);
            background-color: #fffaf5;
            border-radius: var(--border-radius-small);
        }
        .order-address-detail strong, .order-items-detail strong {
            display: block;
            margin-bottom: 5px;
            color: var(--secondary-color);
        }
        .order-items-detail ul {
            list-style: none;
            padding: 0;
            margin-top: 5px;
        }
        .order-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dotted #ccc;
            font-size: 0.9em;
        }
        .order-detail-item:last-child {
            border-bottom: none;
        }

        /* --- Pagina√ß√£o --- */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .pagination-controls button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .pagination-controls button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .page-info {
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        /* --- Media Queries (Responsividade) --- */
        @media (max-width: 768px) {
            .navbar { flex-wrap: wrap; justify-content: space-around; }
            .navbar button { width: 45%; margin: 5px 0; padding: 10px 0; font-size: 14px; }
            .product-grid { grid-template-columns: 1fr; }
            .product-image { height: 120px; }
            
            /* Carrinho Responsivo */
            .cart-item { 
                grid-template-columns: 1fr; 
                grid-template-rows: auto auto auto; 
                gap: 10px; 
                padding: 15px;
            }
            .cart-header { display: none; }
            .item-subtotal { text-align: left; border-top: 1px dashed #eee; padding-top: 10px; font-size: 1em; }
            .cart-actions { justify-content: space-between; border: 1px solid #f0f0f0; padding: 5px; border-radius: 8px; }
            .cart-actions button.remove { margin-left: 0; }
            .cart-actions span.quantity-display { flex-grow: 1; text-align: center; }
            .pagination-controls { flex-direction: column; gap: 10px; }

            /* Grid do Formul√°rio de Endere√ßo em telas pequenas */
            .address-form-grid {
                grid-template-columns: 1fr; /* Coluna √∫nica em telas pequenas */
            }
            .address-form-grid > div {
                grid-column: span 1; /* Todos os campos em largura total */
            }
            .address-form-grid > div.half-width {
                grid-column: span 1; 
            }
        }
    </style>
</head>
<body>

    <div id="app">
        
        <nav class="navbar">
            <button 
                :class="{ 'active': currentView === 'produtos' }" 
                @click="currentView = 'produtos'">
                üõçÔ∏è Produtos
            </button>
            <button 
                :class="{ 'active': currentView === 'carrinho' }" 
                @click="currentView = 'carrinho'">
                üõí Carrinho ({{ totalCartItems }})
            </button>
            <button 
                :class="{ 'active': currentView === 'pedidos' }" 
                @click="currentView = 'pedidos'"
                :disabled="!isLoggedIn"
                :title="!isLoggedIn ? 'Fa√ßa login para ver os pedidos' : ''">
                üì¶ Meus Pedidos
            </button>
            <button @click="isLoggedIn ? logout() : openProfileModal('login')">
                {{ isLoggedIn ? `Sair (${userProfile.name.split(' ')[0]})` : 'üë§ Entrar/Cadastrar' }}
            </button>
        </nav>

        <div class="content-area">

            <div v-if="currentView === 'produtos'">
                <h2>Cat√°logo de Produtos</h2>

                <div v-if="isLoading" class="loading-message">
                    Carregando produtos do Firebase... ‚è≥
                </div>
                <div v-else-if="products.length === 0" class="loading-message" style="background-color: #ffe0e0; color: var(--danger-color);">
                    Nenhum produto encontrado. Verifique a conex√£o ou a estrutura do Firebase.
                </div>

                <div v-else class="product-grid">
                    <div class="product-card" v-for="product in products" :key="product.id">
                        <img :src="product.imageUrl || 'https://via.placeholder.com/250x140?text=Sem+Imagem'" :alt="product.name" class="product-image">
                        <h3>{{ product.name }}</h3>
                        
                        <p>Pre√ßo unit√°rio: R$ **{{ product.price.toFixed(2).replace('.', ',') }}**</p>
                        
                        <div class="quantity-control">
                            <label>Qtd:</label>
                            <input 
                                type="number" 
                                v-model.number="product.quantityToAdd" 
                                min="1" 
                                @change="ensureMinQuantity(product)"
                            >
                        </div>

                        <button @click="addToCart(product, product.quantityToAdd)">
                            Adicionar ao Carrinho
                        </button>
                    </div>
                </div>
            </div>

            <div v-else-if="currentView === 'carrinho'">
                <h2>Seu Carrinho de Compras</h2>
                
                <div class="cart-list" v-if="cartItems.length > 0">
                    <div class="cart-item cart-header">
                        <span>Produto</span>
                        <span style="text-align: center;">Quantidade e A√ß√µes</span>
                        <span style="text-align: right;">Subtotal</span>
                    </div>
                    
                    <div class="cart-item" v-for="item in cartItems" :key="item.id">
                        <div class="cart-item-details">
                            **{{ item.name }}** <br>
                            <em>(R$ {{ item.price.toFixed(2).replace('.', ',') }} / unid.)</em>
                        </div>
                        <div class="cart-actions">
                            <button @click="updateCartQuantity(item, -1)" :disabled="item.quantity <= 1">-</button>
                            <span class="quantity-display">{{ item.quantity }}</span>
                            <button @click="updateCartQuantity(item, 1)">+</button>
                            <button class="remove" @click="removeFromCart(item.id)">Remover</button>
                        </div>
                        
                        <div class="item-subtotal">
                            R$ **{{ (item.price * item.quantity).toFixed(2).replace('.', ',') }}**
                        </div>
                    </div>
                </div>

                <p v-else style="text-align: center; padding: 20px; color: #777;">Seu carrinho est√° vazio. Adicione alguns produtos!</p>

                <div v-if="cartItems.length > 0">
                    <div class="total-section">
                        Total Geral: R$ **{{ totalCartPrice.toFixed(2).replace('.', ',') }}**
                    </div>
                    
                    <div class="checkout-area">
                        <div v-if="isLoggedIn && formattedAddress.trim() !== ''" class="address-info">
                            <strong>Endere√ßo de Entrega Atual:</strong>
                            <p>{{ formattedAddress }}</p>
                            <button 
                                class="checkout-button" 
                                style="background-color: var(--success-color);"
                                @click="confirmOrder">
                                ‚úÖ Confirmar Endere√ßo e Finalizar
                            </button>
                            <button 
                                class="checkout-button" 
                                style="background: none; border: 1px solid var(--primary-color); color: var(--primary-color); margin-top: 10px;"
                                @click="openProfileModal('address')">
                                Mudar Endere√ßo
                            </button>
                        </div>
                        
                        <button 
                            v-else 
                            class="checkout-button" 
                            @click="checkout">
                            Finalizar Compra
                        </button>
                    </div>
                </div>
            </div>

            <div v-else-if="currentView === 'pedidos'">
                <h2>Meus Pedidos (**{{ totalOrdersCount }}** pedidos)</h2>
                
                <div v-if="!isLoggedIn" style="text-align: center; padding: 30px; background-color: #fff0e5; border: 1px solid var(--primary-color); border-radius: 8px; color: var(--secondary-color);">
                    Fa√ßa login para ver seus pedidos.
                </div>
                <div v-else-if="userOrders.length === 0" style="text-align: center; padding: 20px; color: #777;">
                    Voc√™ ainda n√£o tem pedidos finalizados.
                </div>
                
                <div v-else>
                    
                    <div class="pagination-controls" v-if="totalPagesOrders > 1">
                        <button 
                            @click="changePageOrders(currentPageOrders - 1)" 
                            :disabled="currentPageOrders === 1">
                            &lt; Anterior
                        </button>
                        <span class="page-info">
                            P√°gina **{{ currentPageOrders }}** de **{{ totalPagesOrders }}**
                        </span>
                        <button 
                            @click="changePageOrders(currentPageOrders + 1)" 
                            :disabled="currentPageOrders === totalPagesOrders">
                            Pr√≥ximo &gt;
                        </button>
                    </div>
                    
                    <ul class="orders-list">
                        <li class="order-item" v-for="order in paginatedOrders" :key="order.id">
                            <div style="width: 100%;">
                                
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; border-bottom: 1px dashed #ddd; padding-bottom: 10px;">
                                    <div>
                                        **Pedido #{{ order.id.substring(0, 8).toUpperCase() }}** <br>
                                        <span style="font-size: 0.9em; color: #777;">Em: {{ order.date }}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        Status: <span :style="{ color: order.status === 'Processando' ? 'orange' : 'green' }">**{{ order.status }}**</span>
                                        <br>
                                        Total: R$ **{{ order.total.toFixed(2).replace('.', ',') }}**
                                    </div>
                                </div>

                                <div class="order-address-detail">
                                    <strong>Endere√ßo de Entrega:</strong>
                                    <p>{{ formatOrderAddress(order.customer.address) }}</p> 
                                </div>

                                <div class="order-items-detail">
                                    <strong>Itens:</strong>
                                    <ul>
                                        <li v-for="item in order.items" :key="item.id" class="order-detail-item">
                                            <span style="font-weight: 600;">{{ item.quantity }}x</span> 
                                            {{ item.name }} 
                                            <span style="float: right;">R$ {{ (item.price * item.quantity).toFixed(2).replace('.', ',') }}</span>
                                        </li>
                                    </ul>
                                </div>
                                
                            </div>
                        </li>
                    </ul>

                    <div class="pagination-controls" v-if="totalPagesOrders > 1">
                        <button 
                            @click="changePageOrders(currentPageOrders - 1)" 
                            :disabled="currentPageOrders === 1">
                            &lt; Anterior
                        </button>
                        <span class="page-info">
                            P√°gina **{{ currentPageOrders }}** de **{{ totalPagesOrders }}**
                        </span>
                        <button 
                            @click="changePageOrders(currentPageOrders + 1)" 
                            :disabled="currentPageOrders === totalPagesOrders">
                            Pr√≥ximo &gt;
                        </button>
                    </div>
                </div>

            </div>

        </div>

        <div class="modal-overlay" v-if="isProfileModalOpen" @click.self="closeProfileModal">
            <div class="modal-container">
                <button class="modal-close-btn" @click="closeProfileModal">X</button>

                <div v-if="loginView === 'login'">
                    <h3>Acessar sua Conta</h3>
                    <form @submit.prevent="handleLogin()">
                        <input type="email" v-model="tempLogin.email" placeholder="Seu E-mail" required>
                        <input type="password" v-model="tempLogin.password" placeholder="Sua Senha" required>
                        
                        <div class="recover-link">
                            <button type="button" @click="loginView = 'recover'">Esqueci minha senha</button>
                        </div>

                        <button type="submit" class="primary">Entrar</button>
                    </form>
                    <button class="secondary" @click="loginView = 'register'">Ainda n√£o tenho conta? Cadastrar</button>
                </div>

                <div v-else-if="loginView === 'register'">
                    <h3>Criar Conta</h3>
                    <form @submit.prevent="handleRegister()">
                        <input type="text" v-model="tempRegister.name" placeholder="Seu Nome Completo" required>
                        <input type="email" v-model="tempRegister.email" placeholder="Seu Melhor E-mail" required>
                        <input type="password" v-model="tempRegister.password" placeholder="Crie uma Senha Segura (min. 6 caracteres)" required minlength="6">
                        
                        <button type="submit" class="primary">Cadastrar e Entrar</button>
                    </form>
                    <button class="secondary" @click="loginView = 'login'">J√° tenho conta? Acessar</button>
                </div>

                <div v-else-if="loginView === 'recover'">
                    <h3>Recuperar Senha</h3>
                    <p style="font-size: 0.9em; margin-bottom: 20px;">
                        Informe seu e-mail de cadastro. Enviaremos um link para redefini√ß√£o.
                    </p>
                    <form @submit.prevent="handlePasswordRecovery()">
                        <input type="email" v-model="tempRecover.email" placeholder="E-mail de Cadastro" required>
                        
                        <button type="submit" class="primary">Enviar Link</button>
                    </form>
                    <button class="secondary" @click="loginView = 'login'">Voltar ao Login</button>
                </div>

                <div v-else-if="loginView === 'address' && isLoggedIn">
                    <h3>Endere√ßo de Entrega</h3>
                    <p>Ol√°, **{{ userProfile.name.split(' ')[0] }}**. Por favor, preencha seus dados de entrega.</p>
                    <form @submit.prevent="saveAddressAndCheckout">
                        
                        <div class="address-form-grid">
                            
                            <div>
                                <input type="text" v-model="userProfile.address.street" placeholder="Rua / Avenida" required>
                            </div>

                            <div class="half-width">
                                <input type="text" v-model="userProfile.address.number" placeholder="N√∫mero" required>
                            </div>
                            <div class="half-width">
                                <input type="text" v-model="userProfile.address.complement" placeholder="Complemento (apto, bloco, etc.)">
                            </div>

                            <div>
                                <input type="text" v-model="userProfile.address.neighborhood" placeholder="Bairro" required>
                            </div>
                            <div class="half-width">
                                <input type="text" v-model="userProfile.address.city" placeholder="Cidade" required>
                            </div>
                            <div class="half-width">
                                <input type="text" v-model="userProfile.address.zipCode" placeholder="CEP (00000-000)" required>
                            </div>

                        </div>
                        
                        <button type="submit" class="primary">Salvar Endere√ßo e Finalizar</button>
                    </form>
                </div>

            </div>
        </div>
    </div>
    
   <script>
    // --- 1. CONFIGURA√á√ÉO DO FIREBASE ---
    // ‚ö†Ô∏è ATEN√á√ÉO: Substitua pelos seus dados REAIS do Firebase!
    const firebaseConfig = {
        apiKey: "AIzaSyAnGyAYBthXQs5rEylnLXCxOVQKKN1FP34",
        authDomain: "grafica-619fd.firebaseapp.com",
        databaseURL: "https://grafica-619fd-default-rtdb.firebaseio.com", 
        projectId: "grafica-619fd",
        storageBucket: "grafica-619fd.firebasestorage.app",
        messagingSenderId: "1022124441596",
        appId: "1:1022124441596:web:d6f25056f38a6babc67c79",
        measurementId: "G-SQ4QNTFXCM"
    }; 

    let auth = null;
    let db = null;

    const initializeFirebase = () => {
        if (typeof firebase !== 'undefined' && typeof firebase.initializeApp !== 'undefined') {
            try {
                // Previne a inicializa√ß√£o duplicada do aplicativo
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                auth = firebase.auth();
                db = firebase.database();
                console.log("‚úÖ Firebase inicializado com sucesso.");
                
            } catch (e) {
                console.error("‚ùå ERRO GRAVE: Falha ao inicializar o Firebase.", e);
                alert("Erro fatal ao carregar o sistema. Verifique o console.");
            }
        } else {
            console.error("‚ùå ERRO GRAVE: Firebase SDK n√£o carregado. Verifique os links CDN.");
            alert("Erro fatal: Firebase SDK ausente.");
        }
    };

    initializeFirebase();

    // üéØ CONSTANTES DE L√ìGICA üéØ
    const STORAGE_CART_KEY = 'anonymous_cart'; 
    const WHATSAPP_NUMBER = '81995038049'; 

    // --- Fun√ß√£o para criar a estrutura vazia do endere√ßo ---
    const createEmptyAddress = () => ({
        street: '',
        number: '',
        complement: '',
        neighborhood: '',
        city: '',
        zipCode: ''
    });
    
    // --- Fun√ß√µes de Ajuda de Erro do Firebase Auth ---
    const getFirebaseErrorMessage = (error) => {
        console.error("Erro Firebase Code:", error.code, "Mensagem:", error.message);
        
        switch (error.code) {
            case 'auth/email-already-in-use':
                return 'Este e-mail j√° est√° cadastrado. Tente fazer login.';
            case 'auth/invalid-email':
                return 'O e-mail fornecido √© inv√°lido.';
            case 'auth/weak-password':
                return 'A senha deve ter pelo menos 6 caracteres.';
            case 'auth/user-not-found':
            case 'auth/wrong-password':
                return 'E-mail ou senha incorretos.';
            case 'auth/requires-recent-login':
                return '√â necess√°rio fazer o login novamente para realizar esta a√ß√£o.';
            case 'auth/operation-not-allowed':
                return 'O login por e-mail/senha est√° desativado no console do Firebase.';
            case 'auth/network-request-failed':
                return 'Problema de conex√£o com a internet. Tente novamente.';
            default:
                return `Ocorreu um erro desconhecido: ${error.code}. Tente novamente.`;
        }
    };
    // -----------------------------
    
    const { createApp, ref, computed, onMounted, watch } = Vue;
    
    createApp({
        setup() {
            // --- 1. ESTADO CENTRAL ---
            const currentView = ref('produtos'); 
            const isLoggedIn = ref(false); 
            const isLoading = ref(true); 

            const userId = ref(null); 
            
            const userProfile = ref({
                name: 'Convidado',
                email: '',
                address: createEmptyAddress() 
            });

            const isProfileModalOpen = ref(false);
            const loginView = ref('login'); 

            const tempLogin = ref({ email: '', password: '' });
            const tempRegister = ref({ name: '', email: '', password: '' }); 
            const tempRecover = ref({ email: '' }); 

            const products = ref([]); 
            const cartItems = ref([]);
            const userOrders = ref([]); 
            const currentPageOrders = ref(1); 
            
            // -----------------------------------------------------------
            // FUN√á√ïES DE SINCRONIZA√á√ÉO DE DADOS (CARRINHO E PERFIL) 
            // -----------------------------------------------------------

            const saveCartLocal = () => {
                if (!isLoggedIn.value) {
                    localStorage.setItem(STORAGE_CART_KEY, JSON.stringify(cartItems.value));
                }
            };

            const loadCartLocal = () => {
                const storedCart = localStorage.getItem(STORAGE_CART_KEY);
                if (storedCart) {
                    try {
                        cartItems.value = JSON.parse(storedCart).map(item => ({...item, quantityToAdd: 1}));
                    } catch (e) {
                        cartItems.value = [];
                    }
                } else {
                    cartItems.value = [];
                }
            };

            const saveCartToFirebase = async () => {
                if (!userId.value || !db) return; 
                const cartRef = db.ref(`usuarios/${userId.value}/carrinho`);
                
                try {
                    const cartDataToSave = cartItems.value.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        imageUrl: item.imageUrl,
                        quantity: item.quantity
                    }));
                    await cartRef.set(cartDataToSave);
                } catch (error) {
                    console.error("Erro ao salvar carrinho no Firebase:", error);
                }
            };
            
            const loadCartFromFirebase = async () => {
                if (!userId.value || !db) return;
                
                const cartRef = db.ref(`usuarios/${userId.value}/carrinho`);
                
                try {
                    const snapshot = await cartRef.get();
                    if (snapshot.exists()) {
                        const loadedCart = snapshot.val();
                        // Garante que √© um array (necess√°rio se houver itens)
                        cartItems.value = Array.isArray(loadedCart) ? loadedCart.map(item => ({...item, quantityToAdd: 1})) : [];
                    } else {
                        cartItems.value = [];
                    }
                } catch (error) {
                    console.error("Erro ao carregar carrinho do Firebase:", error);
                    cartItems.value = [];
                }
            };

            const loadUserProfileFromFirebase = async (uid) => {
                if (!uid || !db) return;
                
                const userRef = db.ref(`usuarios/${uid}`);
                
                try {
                    const snapshot = await userRef.get();
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        userProfile.value.name = userData.name || auth.currentUser.displayName || 'Usu√°rio';
                        userProfile.value.email = userData.email || auth.currentUser.email;
                        // Usa dados salvos, ou endere√ßo vazio como fallback
                        userProfile.value.address = userData.address || createEmptyAddress(); 
                    } else {
                        // Se n√£o h√° perfil no RTDB, usa dados do Auth e cria endere√ßo vazio
                        userProfile.value.name = auth.currentUser.displayName || auth.currentUser.email.split('@')[0];
                        userProfile.value.email = auth.currentUser.email;
                        userProfile.value.address = createEmptyAddress();
                        
                        // Opcional: Salva o perfil m√≠nimo no RTDB se ele n√£o existir
                        userRef.set({
                            name: userProfile.value.name,
                            email: userProfile.value.email,
                            address: userProfile.value.address,
                            createdAt: firebase.database.ServerValue.TIMESTAMP 
                        }).catch(e => console.warn("Falha ao criar perfil m√≠nimo no DB:", e));
                    }
                } catch (error) {
                    console.error("Erro ao carregar perfil do DB:", error);
                }
            };
            
            const loadOrdersFromFirebase = async () => {
                if (!userId.value || !db) {
                    userOrders.value = [];
                    return;
                }

                const ordersRef = db.ref(`pedidos/${userId.value}`); 
                
                try {
                    // Ordena por chave para pegar os pedidos em ordem de cria√ß√£o (assumindo que as chaves s√£o timestamps)
                    const snapshot = await ordersRef.orderByKey().get(); 
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        // Converte objeto de pedidos em array e inverte para o mais recente primeiro
                        userOrders.value = Object.keys(data).map(key => ({
                            id: key, 
                            ...data[key]
                        })).reverse(); 
                    } else {
                        userOrders.value = [];
                    }
                    currentPageOrders.value = 1; 
                } catch (error) {
                    console.error("Erro ao carregar pedidos do Firebase:", error);
                    userOrders.value = [];
                }
            };

            // Observa a altera√ß√£o do carrinho e salva no local ou no Firebase
            watch(cartItems, () => {
                if (isLoggedIn.value) {
                    saveCartToFirebase();
                } else {
                    saveCartLocal();
                }
            }, { deep: true });

            // -----------------------------------------------------------
            // INICIALIZA√á√ÉO, PRODUTOS E AUTENTICA√á√ÉO
            // -----------------------------------------------------------

            const fetchProductsFromFirebase = async () => {
                if (!db) {
                    isLoading.value = false;
                    return;
                }
                
                const productsRef = db.ref('produtos'); 

                try {
                    const snapshot = await productsRef.get();
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        const loadedProducts = [];

                        for (const key in data) {
                            if (data.hasOwnProperty(key)) {
                                const productData = data[key];
                                loadedProducts.push({
                                    id: key, 
                                    name: productData.name || 'Produto sem nome',
                                    imageUrl: productData.imageUrl || '',
                                    price: parseFloat(productData.price) || 0, 
                                    quantityToAdd: 1 
                                });
                            }
                        }
                        products.value = loadedProducts;
                    } else {
                        products.value = [];
                    }
                } catch (error) {
                    console.error("Erro ao buscar produtos do Firebase:", error);
                    alert("Erro ao carregar o cat√°logo. Verifique sua conex√£o.");
                } finally {
                    // N√£o encerra o loading aqui. O onAuthStateChanged far√° isso.
                }
            };

            const initializeApp = () => {
                if (!auth) {
                    isLoading.value = false;
                    return;
                }
                
                auth.onAuthStateChanged(async (user) => {
                    const cartBeforeAuth = cartItems.value.slice(); // Salva o carrinho an√¥nimo

                    if (user) {
                        // Usu√°rio Logado
                        userId.value = user.uid;
                        isLoggedIn.value = true;
                        
                        await loadUserProfileFromFirebase(user.uid);
                        await loadCartFromFirebase();
                        await loadOrdersFromFirebase();
                        
                        // Transfere o carrinho an√¥nimo para o Firebase se o carrinho do DB estava vazio
                        if (cartItems.value.length === 0 && cartBeforeAuth.length > 0) {
                            cartItems.value = cartBeforeAuth; 
                            localStorage.removeItem(STORAGE_CART_KEY); 
                            // O watch cuidar√° de salvar no Firebase.
                            console.log(`Carrinho an√¥nimo (${cartBeforeAuth.length} itens) transferido.`);
                        }
                        
                    } else {
                        // Usu√°rio Desconectado ou An√¥nimo
                        userId.value = null;
                        isLoggedIn.value = false;
                        userProfile.value = { name: 'Convidado', email: '', address: createEmptyAddress() };
                        userOrders.value = [];
                        loadCartLocal(); // Carrega o carrinho an√¥nimo
                    }
                    isLoading.value = false;
                });
            };
            
            onMounted(() => {
                // Carrega produtos e depois inicia a observa√ß√£o do estado do Auth
                fetchProductsFromFirebase().then(initializeApp);
            });

            // --- 2. PROPRIEDADES COMPUTADAS (Calculadas) ---
            
            const formattedAddress = computed(() => {
                const addr = userProfile.value.address;
                if (!addr || !addr.street || !addr.number || !addr.city) {
                    return ''; // Endere√ßo incompleto/vazio
                }
                let parts = [];
                parts.push(`${addr.street}, ${addr.number}`);
                if (addr.complement) {
                    parts.push(`Comp: ${addr.complement}`);
                }
                parts.push(addr.neighborhood);
                parts.push(`${addr.city} (CEP: ${addr.zipCode})`);
                
                return parts.join(' | ');
            });
            
            const formatOrderAddress = (addr) => {
                if (!addr || typeof addr === 'string') {
                    return addr || 'Endere√ßo n√£o informado'; 
                }
                
                let parts = [];
                parts.push(`${addr.street}, ${addr.number}`);
                if (addr.complement) {
                    parts.push(`Comp: ${addr.complement}`);
                }
                parts.push(addr.neighborhood);
                parts.push(`${addr.city} (CEP: ${addr.zipCode})`);
                
                return parts.join(' | ');
            };
            
            const totalCartItems = computed(() => {
                return cartItems.value.reduce((total, item) => total + item.quantity, 0);
            });

            const totalCartPrice = computed(() => {
                return cartItems.value.reduce((total, item) => total + (item.price * item.quantity), 0);
            });
            
            const totalOrdersCount = computed(() => userOrders.value.length);

            const itemsPerPageOrders = 5;

            const totalPagesOrders = computed(() => {
                return Math.ceil(userOrders.value.length / itemsPerPageOrders);
            });

            const paginatedOrders = computed(() => {
                const start = (currentPageOrders.value - 1) * itemsPerPageOrders;
                const end = start + itemsPerPageOrders;
                return userOrders.value.slice(start, end);
            });

            // --- 3. M√âTODOS DE AUTENTICA√á√ÉO E PERFIL ---
            
            const openProfileModal = (view = 'login') => {
                loginView.value = view;
                isProfileModalOpen.value = true;
            };

            const closeProfileModal = () => {
                isProfileModalOpen.value = false;
            };
            
            // Login com Firebase Auth
            const handleLogin = async () => {
                if (!auth) return alert("Sistema de autentica√ß√£o indispon√≠vel.");
                const { email, password } = tempLogin.value;
                if (!email || !password) return alert("Preencha e-mail e senha.");

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    closeProfileModal();
                    tempLogin.value = { email: '', password: '' }; // Limpa campos
                } catch (error) {
                    alert(getFirebaseErrorMessage(error));
                }
            };

            // Cadastro com Firebase Auth e cria√ß√£o de metadados no DB
            const handleRegister = async () => { 
                if (!auth || !db) return alert("Sistema de autentica√ß√£o indispon√≠vel.");
                const { name, email, password } = tempRegister.value;
                
                if (!name || !email || password.length < 6) {
                    return alert("Preencha todos os campos corretamente (Nome, E-mail, Senha > 6 chars).");
                }
                
                try {
                    // 1. Cria o usu√°rio no Auth
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    // 2. Atualiza o nome de exibi√ß√£o no Auth
                    await user.updateProfile({ displayName: name });

                    // 3. Salva os metadados no Realtime Database
                    const userRef = db.ref(`usuarios/${user.uid}`);
                    await userRef.set({
                        name: name,
                        email: email,
                        address: createEmptyAddress(),
                        createdAt: firebase.database.ServerValue.TIMESTAMP 
                    });
                    
                    alert(`üéâ Cadastro realizado com sucesso! Bem-vindo(a), ${name}.`);
                    tempRegister.value = { name: '', email: '', password: '' }; // Limpa campos
                    closeProfileModal();

                } catch (error) {
                    alert(getFirebaseErrorMessage(error));
                    // Se a autentica√ß√£o falhar, remove qualquer login tempor√°rio que possa ter ocorrido
                    if (auth.currentUser) {
                        auth.signOut();
                    }
                }
            };

            // Recupera√ß√£o de senha com Firebase Auth
            const handlePasswordRecovery = async () => { 
                if (!auth) return alert("Sistema de autentica√ß√£o indispon√≠vel.");
                const email = tempRecover.value.email;
                if (!email) return alert("Por favor, insira um e-mail.");
                
                try {
                    await auth.sendPasswordResetEmail(email);
                    
                    alert(`‚úÖ E-mail de redefini√ß√£o enviado para: ${email}. Verifique sua caixa de entrada e spam.`);
                    
                    loginView.value = 'login';
                    tempRecover.value.email = ''; 
                } catch (error) {
                    alert(getFirebaseErrorMessage(error));
                }
            };

            const logout = async () => {
                if (!auth) return;
                try {
                    await auth.signOut();
                    // O onAuthStateChanged cuida da limpeza do estado local
                    alert("Sess√£o encerrada com sucesso.");
                } catch (error) {
                    console.error("Erro ao fazer logout:", error);
                    alert("Erro ao sair. Tente novamente.");
                }
                currentView.value = 'produtos';
            };

            const changePageOrders = (page) => {
                if (page >= 1 && page <= totalPagesOrders.value) {
                    currentPageOrders.value = page;
                }
            };
            
            // --- 4. FUN√á√ïES DE CARRINHO E CHECKOUT ---
            
            const ensureMinQuantity = (product) => {
                if (product.quantityToAdd < 1 || isNaN(product.quantityToAdd)) {
                    product.quantityToAdd = 1;
                }
            };

            const addToCart = (product, quantity) => {
                const qty = Math.max(1, parseInt(quantity) || 1);
                
                const existingItem = cartItems.value.find(item => item.id === product.id);
                
                if (existingItem) {
                    existingItem.quantity += qty;
                } else {
                    cartItems.value.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        imageUrl: product.imageUrl,
                        quantity: qty,
                    });
                }
                // O watch cuidar√° do saveLocal/saveFirebase
            };

            const updateCartQuantity = (item, delta) => {
                const newQuantity = item.quantity + delta;
                
                if (newQuantity < 1) {
                    removeFromCart(item.id);
                } else {
                    item.quantity = newQuantity;
                }
            };

            const removeFromCart = (productId) => {
                cartItems.value = cartItems.value.filter(item => item.id !== productId);
            };
            
            const checkout = () => {
                if (totalCartItems.value === 0) {
                    alert("Seu carrinho est√° vazio!");
                    return;
                }

                if (!isLoggedIn.value) {
                    alert("Por favor, fa√ßa login ou cadastre-se para finalizar a compra.");
                    openProfileModal('login');
                    return;
                }
                
                if (formattedAddress.value.trim() === '') {
                    alert("Por favor, preencha seu endere√ßo para finalizar o pedido.");
                    openProfileModal('address'); 
                    return;
                }
                
                // Se tudo estiver OK, o usu√°rio deve revisar o endere√ßo antes de confirmar
                openProfileModal('address');
            };
            
            const saveAddressAndCheckout = async () => {
                if (!db || !userId.value) return;

                const addr = userProfile.value.address;
                if (!addr.street || !addr.number || !addr.neighborhood || !addr.city || !addr.zipCode) {
                    alert("Por favor, preencha todos os campos obrigat√≥rios do endere√ßo (Rua, N√∫mero, Bairro, Cidade, CEP).");
                    return;
                }

                const userRef = db.ref(`usuarios/${userId.value}`);

                try {
                    // Atualiza o endere√ßo no Realtime Database
                    await userRef.update({ address: userProfile.value.address });
                    
                    closeProfileModal();
                    confirmOrder(); // Procede com a finaliza√ß√£o
                } catch (error) {
                    console.error("Erro ao salvar endere√ßo:", error);
                    alert("Erro ao salvar o endere√ßo. Tente novamente.");
                }
            };
            
            // --- 5. FINALIZA√á√ÉO DO PEDIDO (FIREBASE + WHATSAPP) ---
            
            const sendOrderDetailsToWhatsApp = (orderId, orderData) => {
                
                const customerAddress = formatOrderAddress(orderData.customer.address);

                const itemsList = orderData.items.map(item => 
                    `* ${item.quantity}x ${item.name} (R$ ${item.price.toFixed(2).replace('.', ',')})`
                ).join('\n');

                const message = `
                    üõí *NOVO PEDIDO RECEBIDO!* üõí

                    *ID do Pedido:* #${orderId.substring(0, 8).toUpperCase()}
                    *Data:* ${orderData.date}
                    *Total:* R$ ${orderData.total.toFixed(2).replace('.', ',')}

                    *CLIENTE:*
                    *Nome:* ${orderData.customer.name}
                    *Email:* ${orderData.customer.email}
                    *Endere√ßo:* ${customerAddress}

                    *ITENS DO PEDIDO:*
                    ${itemsList}

                    *(Confirme o pagamento e o envio. Agradecemos a prefer√™ncia!)*
                `.trim();

                const encodedMessage = encodeURIComponent(message);
                const whatsappLink = `https://wa.me/55${WHATSAPP_NUMBER}?text=${encodedMessage}`;

                // Abre o link do WhatsApp
                window.open(whatsappLink, '_blank');
            };

            const confirmOrder = async () => {
                if (!isLoggedIn.value || !userId.value || !db) {
                    alert("Erro de sistema: Voc√™ precisa estar logado.");
                    return;
                }
                if (totalCartItems.value === 0) {
                    alert("Seu carrinho est√° vazio!");
                    return;
                }

                // Cria uma nova chave √∫nica para o pedido (timestamp-based key)
                const newOrderRef = db.ref(`pedidos/${userId.value}`).push();

                const orderData = {
                    date: new Date().toLocaleString('pt-BR'),
                    total: totalCartPrice.value,
                    status: 'Processando',
                    items: cartItems.value.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity
                    })),
                    customer: {
                        name: userProfile.value.name,
                        email: userProfile.value.email,
                        address: userProfile.value.address // Endere√ßo atual salvo
                    }
                };

                try {
                    await newOrderRef.set(orderData);
                    
                    // Notifica via WhatsApp
                    sendOrderDetailsToWhatsApp(newOrderRef.key, orderData);
                    
                    // Limpa o carrinho e atualiza pedidos
                    cartItems.value = []; 
                    await loadOrdersFromFirebase(); 
                    currentView.value = 'pedidos';
                    alert("Pedido finalizado com sucesso! Redirecionando para o WhatsApp para confirmar.");

                } catch (error) {
                    console.error("Erro ao finalizar pedido:", error);
                    alert("Ocorreu um erro ao processar seu pedido. Tente novamente.");
                }
            };
            
            return {
                // Estado e Computadas
                currentView, products, cartItems, userOrders, userProfile, isLoggedIn, isLoading,
                isProfileModalOpen, loginView, tempLogin, tempRegister, tempRecover, 
                totalCartItems, totalCartPrice, totalOrdersCount, 
                currentPageOrders, totalPagesOrders, paginatedOrders, 
                formattedAddress, formatOrderAddress, 

                // M√©todos
                openProfileModal, closeProfileModal, ensureMinQuantity,
                handleLogin, handleRegister, logout, handlePasswordRecovery, 
                addToCart, updateCartQuantity, removeFromCart, checkout, saveAddressAndCheckout, confirmOrder,
                changePageOrders 
            };
        }
    }).mount('#app');
</script>